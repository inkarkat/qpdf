#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Apply a (single-page) PDF file as an underlaid letterhead to the passed
PDF-FILE(s), writing as PDF-FILE.LETTERHEAD.pdf
HELPTEXT
    echo
    printf 'Usage: %q %s\n' "$(basename "$1")" '[-r|--replace] [-l|--letterhead LETTERHEAD-FILE] [--] PDF-FILE [...] [-?|-h|--help]'
}

letterheadDirspec=~/templates/letterheads
letterheadFilespec="${letterheadDirspec}/ingo.pdf"
letterheadInsertion=letterhead
isReplace=
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--replace|-r)	shift; isReplace=t;;
	--letterhead|-l)
			shift
			if [ -e "${1:?}" ]; then
			    letterheadFilespec="$1"
			else
			    letterheadFilespec="${letterheadDirspec}/$1"
			    if [ ! -e "$letterheadFilespec" ]; then
				printf >&2 'ERROR: Letterhead file not found: %s\n' "$1"
				exit 2
			    fi
			fi
			shift
			letterheadInsertion="$(fileExtension --basename -- "$letterheadFilespec")"
			;;
	--)		shift; break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done

typeset -a qpdfArgs=() outputFilespec=()
status=0
for filespec
do
    [ "$isReplace" ] \
	&& typeset -a qpdfArgs=(--replace-input) \
	|| typeset -a outputFilespec=("${filespec}${letterheadInsertion:+.}${letterheadInsertion}.pdf")

    qpdf "${qpdfArgs[@]}" --underlay "$letterheadFilespec" --to=1 -- "$filespec" "${outputFilespec[@]}" || status=$?
done
exit $status
